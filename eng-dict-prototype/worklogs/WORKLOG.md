# 项目调试阶段总结报告（英语词典桌面应用）
### 时间：2025年11月26日
## 结论摘要
- 主要阻碍源于环境与集成不一致：浏览器自动化版本漂移、打包路径与开发路径不统一、页面事件绑定在自动化与桌面环境中的行为差异。
- 架构与测试策略需要更早确定：离线数据与可控钩子缺失、网络依赖导致不稳定、E2E 对 UI 状态缺少明确可观察点。
- 通过添加测试钩子、显式状态切换与报告生成后，核心流程（查询与浮层显示、模块触发浮层）已稳定；收藏列表刷新与“开始复习”入口仍需小幅稳定化修复（已在进行）。

## 遇到的问题与原因分析
- Playwright MCP 浏览器版本不匹配
  - 现象：启动浏览器报错（找不到 `chromium-1179`）、甚至 SIGSEGV 崩溃。
  - 原因：MCP 插件绑定旧缓存路径，与本机安装的 Playwright 版本不一致。
  - 影响：无法直接自动化；需强制使用项目内浏览器并对齐版本。

- 桌面打包加载空白
  - 现象：`EngDict.app` 打开窗口无内容。
  - 原因：`tauri.conf.json` 的 `distDir` 与真实前端文件路径不一致；开发模式与打包模式路径差异导致资源未加载。
  - 处理：将前端复制到 `frontend/`，修正 `distDir` 并重新构建。

- UI 事件绑定与显示状态不一致
  - 现象：点击“打开浮层”后浮层仍隐藏；自动化中按钮点击不触发显示。
  - 原因：事件绑定在某些环境中未执行到、或状态切换依赖内部变量；CSS 类未按预期添加。
  - 处理：
    - 添加测试钩子（`__TEST_QUERY`、`__TEST_SHOW_OVERLAY` 等）与显式状态兜底（`overlay.style.display='flex'`）。
    - 调试面板与日志输出（收集点击与状态）。

- 网络依赖导致查询不稳定
  - 现象：查询走在线词典 API，网络异常时无释义。
  - 原因：缺少离线词库与稳定的 API mock。
  - 处理：在自动化中改为文件路径加载与兜底文案，后续应引入离线词库与 Mock 层。

- 计划页入口与收藏刷新
  - 现象：自动化点击“开始复习”模块不可见、收藏列表未增量。
  - 原因：入口初始渲染态与同步刷新缺少明确的调度与可观察点。
  - 处理（进行中）：入口默认可见、收藏后显式刷新列表并使用等待式断言。

## 我们做了什么
- 前端
  - 新增“外观”页与参考图主题切换；悬浮窗浅色拟物风格与胶囊拖动条。
  - 事件钩子与调试面板（日志可视化）；浮层显示兜底；词形规范化与 SM-2 调度。
  - 打包与桌面化：Tauri 主进程全局快捷键（收藏/悬浮窗），悬浮窗窗口创建与剪贴板读取。
- 自动化
  - 基础用例（查询与浮层、模块触发浮层）稳定通过。
  - 扩展用例（发音/收藏/背词/导出导入）已编写并进入稳定化阶段；生成 HTML 报告服务。

## 下次的改进建议
- 环境与版本管理
  - 固定 Playwright 版本与浏览器构建号，统一用项目内浏览器（`PLAYWRIGHT_BROWSERS_PATH=0`）。
  - 对 MCP 服务明确环境变量与启动方式，避免使用系统旧缓存。

- 打包路径与资源管理
  - 在需求阶段确定 `distDir` 与静态资源结构；对开发/打包两种路径写入清晰文档与检查脚本。

- 测试策略（先立后行）
  - 先写关键交互的可观察点与测试钩子（或 data-testid），避免依赖纯视觉状态。
  - 引入离线词库与 API Mock，减少网络不确定性。
  - 统一断言：显式类名/属性与可见性，少用隐式动画等待。

- 日志与诊断
  - 为关键入口添加日志（点击、状态切换、错误捕获），在报告中聚合输出。
  - 为桌面主进程与前端建立统一诊断通道（如 IPC 事件日志）。

- 可见性与可点击性
  - 初始渲染时确保关键入口处于可见状态（如“开始复习”）；避免模块默认隐藏。
  - 状态切换采用显式 `classList` 与兜底样式，减少浏览器差异。

## 交付与当前状态
- 基础流程已稳定：查询显示、模块触发浮层。
- 扩展用例（收藏、背词入口）正在稳定化修复，完成后将更新报告。
- HTML 报告地址：`http://localhost:9323`（运行时可访问）。

---

*本报告自动生成，后续修复完成将追加最新结论与通过用例截图。*
